{"name":"Roll and Apply Devise a Stratagem","type":"script","scope":"global","author":"1nIvj2kghHEjRn0P","img":"systems/pf2e/icons/features/classes/devise-a-stratagem.webp","command":"// Check for actors\nconst actors = canvas.tokens.controlled.flatMap((token) => token.actor ?? []);\nif (actors.length === 0 && game.user.character)\n  actors.push(game.user.character);\nif (actors.length === 0) {\n  const message = game.i18n.localize(\"PF2E.ErrorMessage.NoTokenSelected\");\n  return ui.notifications.error(message);\n}\n\nconst modifiers = [];\nconst ITEM_UUID =\n  \"Compendium.pf2e-investigators-pnc.investigators-pnc-effects.8NykV7Oba6oX2log\"; // Effect: Devise a Stratagem\n\nfor (const actor of actors) {\n  const existing = actor.itemTypes.effect.find(\n    (e) => e.flags.core?.sourceId === ITEM_UUID\n  );\n  if (existing) {\n    await existing.delete();\n  } else {\n    if (\n      !actor.itemTypes.action.some((wm) => wm.slug === \"devise-a-stratagem\")\n    ) {\n      ui.notifications.warn(\n        `${actor.name} does not have the ability to Devise a Stratagem.`\n      );\n      return;\n    }\n\n    const roll = await game.pf2e.Check.roll(\n      new game.pf2e.StatisticModifier(`<h1>Devise a Stratagem</h1>`, modifiers),\n      { skipDialog: true }\n    );\n    const rollResult = roll.total;\n\n    const source = (await fromUuid(ITEM_UUID)).toObject();\n    source.flags = mergeObject(source.flags ?? {}, {\n      core: { sourceId: ITEM_UUID },\n    });\n    source.system = mergeObject(source.system ?? {}, {\n      badge: { value: rollResult },\n    });\n\n    await actor.createEmbeddedDocuments(\"Item\", [source]);\n  }\n}","ownership":{"default":0,"1nIvj2kghHEjRn0P":3},"flags":{"core":{"sourceId":"Macro.79PSxMqjKUF0y0mO"}},"_stats":{"systemId":"pf2e","systemVersion":"4.1.3","coreVersion":"10.286","createdTime":1664799311087,"modifiedTime":1664801819243,"lastModifiedBy":"1nIvj2kghHEjRn0P"},"folder":null,"sort":0,"_id":"A4xNoITwvFcczSQL"}
